<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Transfer Management System - Boxtel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #FF6B00; --secondary: #003DA5; --success: #4CAF50; --warning: #FF9800; --danger: #f44336; --dark: #2c3e50; --light: #ecf0f1; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, #003DA5 0%, #FF6B00 100%); min-height: 100vh; padding: 15px; }
        .language-toggle { position: fixed; top: 20px; right: 20px; z-index: 1001; display: flex; gap: 5px; background: white; padding: 5px; border-radius: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .lang-btn { padding: 8px 15px; border: none; background: transparent; cursor: pointer; border-radius: 20px; font-weight: 600; transition: all 0.3s; }
        .lang-btn.active { background: var(--primary); color: white; }
        .container { max-width: 1600px; margin: 0 auto; background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        h1 { font-size: 24px; font-weight: 700; }
        .table-container { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        thead { background: #f8f9fa; }
        th { font-weight: 600; color: #666; font-size: 12px; text-transform: uppercase; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; }
        .status-production { background: #e3f2fd; color: #1976d2; }
        .status-ready { background: #e8f5e9; color: #388e3c; }
        .status-dismantling { background: #fff3e0; color: #f57c00; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%); color: white; }
        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; }
        .notification { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transform: translateY(120px); opacity: 0; transition: all 0.5s; z-index: 1100; }
        .notification.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span>üè≠</span> Machine Transfer Management - Boxtel</h1>
        </div>
        <div class="control-panel" style="padding: 15px 20px; background: #f8f9fa;">
            <button class="btn btn-primary" onclick="openModal()">‚ûï Machine toevoegen</button>
        </div>
        <div class="content">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Machine</th>
                            <th>Nr.</th>
                            <th>Status</th>
                            <th>Bestemming</th>
                            <th>Verantwoordelijk</th>
                            <th>Opmerkingen</th>
                            <th>Acties</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="machineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Machine Toevoegen/Bewerken</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="machine-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Machine Type*</label>
                        <input type="text" id="machine-type" required>
                    </div>
                    <div class="form-group">
                        <label>Machine Nummer</label>
                        <input type="text" id="machine-number">
                    </div>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label>Status*</label>
                        <select id="machine-status" required><option>In productie</option><option>Gereed voor transport</option><option>Demontage</option></select>
                    </div>
                    <div class="form-group">
                        <label>Bestemming*</label>
                        <input type="text" id="machine-destination" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Verantwoordelijke*</label>
                    <input type="text" id="machine-responsible" required>
                </div>
                <div class="form-group">
                    <label>Opmerkingen</label>
                    <textarea id="machine-notes"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <div class="auth-input" style="margin-right: auto; display: flex; align-items: center; gap: 8px;">
                    <label>Autorisatie code:</label>
                    <input type="password" id="auth-code" placeholder="***" maxlength="3">
                </div>
                <button class="btn" onclick="closeModal()">Annuleren</button>
                <button class="btn btn-primary" onclick="saveMachine()">Opslaan</button>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    
    <script>
        const API_URL = '/api/machines';
        const modal = document.getElementById('machineModal');
        const machineIdInput = document.getElementById('machine-id');

        // --- Data Functions ---
        async function loadMachines() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Failed to fetch machines');
                const machines = await response.json();
                renderTable(machines);
            } catch (error) {
                console.error('Error loading machines:', error);
                showNotification('Error loading machines', 'error');
            }
        }

        async function saveMachine() {
            const authCode = document.getElementById('auth-code').value;
            if (!authCode) {
                showNotification('Authorization code is required.', 'error');
                return;
            }

            const machineData = {
                type: document.getElementById('machine-type').value,
                number: document.getElementById('machine-number').value,
                status: document.getElementById('machine-status').value,
                destination: document.getElementById('machine-destination').value,
                responsible: document.getElementById('machine-responsible').value,
                notes: document.getElementById('machine-notes').value,
                authCode: authCode
            };

            const id = machineIdInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(machineData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Save failed');
                }

                showNotification('Machine saved successfully!', 'success');
                closeModal();
                loadMachines(); // Refresh the table
            } catch (error) {
                console.error('Error saving machine:', error);
                showNotification(`Error: ${error.message}`, 'error');
            }
        }

        async function editMachine(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`);
                if (!response.ok) throw new Error('Machine not found');
                const machine = await response.json();

                machineIdInput.value = machine._id;
                document.getElementById('machine-type').value = machine.type;
                document.getElementById('machine-number').value = machine.number;
                document.getElementById('machine-status').value = machine.status;
                document.getElementById('machine-destination').value = machine.destination;
                document.getElementById('machine-responsible').value = machine.responsible;
                document.getElementById('machine-notes').value = machine.notes;

                openModal();
            } catch (error) {
                console.error('Error fetching machine for edit:', error);
                showNotification(error.message, 'error');
            }
        }

        async function deleteMachine(id) {
            if (!confirm('Are you sure you want to delete this machine?')) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');

                showNotification('Machine deleted successfully.', 'success');
                loadMachines();
            } catch (error) {
                console.error('Error deleting machine:', error);
                showNotification('Error deleting machine.', 'error');
            }
        }

        // --- UI Functions ---
        function renderTable(machines) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            machines.forEach(machine => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${machine.type}</td>
                    <td>${machine.number || '-'}</td>
                    <td><span class="status-badge status-${(machine.status || '').toLowerCase().replace(/ /g, '-')}">${machine.status}</span></td>
                    <td>${machine.destination}</td>
                    <td>${machine.responsible}</td>
                    <td>${machine.notes || ''}</td>
                    <td>
                        <button class="btn" onclick="editMachine('${machine._id}')">‚úèÔ∏è</button>
                        <button class="btn" onclick="deleteMachine('${machine._id}')">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openModal() {
            // Reset form for new entry if no ID is set
            if (!machineIdInput.value) {
                document.getElementById('machine-type').value = '';
                document.getElementById('machine-number').value = '';
                document.getElementById('machine-destination').value = '';
                document.getElementById('machine-responsible').value = '';
                document.getElementById('machine-notes').value = '';
            }
            modal.classList.add('active');
        }

        function closeModal() {
            machineIdInput.value = ''; // Clear ID on close
            modal.classList.remove('active');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadMachines);
    </script>
</body>
</html>